from services.solar_panels.helpers.solar_panels import get_all_solar_panels
import json

async def get_prices_prompt(data, session):
    solar_panels = await get_all_solar_panels(session=session)

    solar_panels_json = json.dumps(solar_panels, ensure_ascii=False, separators=(',', ':'))
    data_json = json.dumps(data, ensure_ascii=False, separators=(',', ':'))

    prompt = f"""
Я маю дві групи даних:

1. Сонячні панелі з моєї бази даних:

2. Дані про сонячні панелі від постачальника:
(в них часто деякі параметри є NULL, ти ігноруй це і не враховуй це поле для порівняння співпадіння)

Твоє завдання — для кожної сонячної панелі від постачальника знайти найбільш схожу сонячну панель з бази даних та повернути результат у вигляді списку об'єктів JSON.

ВАЖЛИВО: Я хочу, щоб ти знайшов співпадіння для КОЖНОЇ панелі від постачальника. Якщо є хоч якась схожість за брендом і потужністю - це вже співпадіння!

Формат для кожного знайденого співпадіння (коли знайдено панель у базі даних):
{{
    "price": <float>,
    "price_per_w": <float>,
    "panel_id": <int>
}}

ВАЖЛИВО: Якщо ти знайшов співпадіння і panel_id не null, то повертай саме у такому форматі з трьома полями. Якщо співпадіння не знайдено, тоді повертай повний об'єкт з panel_id: null.

Обов'язково має бути price!!!! без нього не повертай

АЛГОРИТМ ПОРІВНЯННЯ:
1. БРЕНД (brand): Порівнюй бренди, ігноруючи регістр і пробіли. Наприклад, "JA Solar", "JASolar", "JA-Solar" - це один і той самий бренд.
2. НАЗВА (full_name): Шукай ключові слова та номери моделей, навіть якщо повна назва відрізняється.
3. ДОДАТКОВІ ПОЛЯ: Використовуй panel_type, cell_type, thickness для уточнення, але вони менш важливі.

ПРИКЛАДИ ПОРІВНЯННЯ:
- Панель "JA Solar JAM54D30 545W" з бази даних (id: 1) і панель "JA Solar 545W" від постачальника - це СПІВПАДІННЯ
- Панель "Longi LR5-66HPH-550M" з бази даних (id: 2) і панель "Longi Solar 550W" від постачальника - це СПІВПАДІННЯ
- Панель "JinkoSolar Tiger Neo 555W N-Type" з бази даних (id: 3) і панель "Jinko 555W" від постачальника - це СПІВПАДІННЯ
- Панель "JA Solar 450W" з бази даних (id: 4) і панель "JA Solar 460W" від постачальника - це СПІВПАДІННЯ (різниця в потужності допустима)

ВАЖЛИВО: Якщо бренд і потужність співпадають або дуже близькі, це майже напевно та сама панель! Навіть якщо інші поля відрізняються.

ВАЖЛИВО: Якщо price_per_w відсутній у даних постачальника, але є price і power, обчисли його як price / power.

Якщо не вдалося знайти схожу сонячну панель, поверни повний об'єкт постачальника з усіма полями, які він містить, але додай поле `"panel_id": null`. Наприклад:
{{
    "brand": "JinkoSolar", <str>
    "power": 450.0, <float> | <None>
    "full_name": "JinkoSolar Tiger Neo N-type 450W", <str> 
    "price": 150.0, <float>
    "panel_type": "одностороння" <str> | <None>,
    "cell_type": "n-type" <str> | <None>,
    "thickness": 30.0, <float> | <None>,
    "panel_id": null <null>
    "panel_color": "Default" <str> | <None>,
    "frame_color": "silver" <str> | <None>,
    "price_per_w": 0.15<float>
}}

❗️Поверни лише **чистий JSON без пояснень**, без додаткового тексту.
1. Сонячні панелі з моєї бази даних:
{solar_panels_json}

2. Дані про сонячні панелі від постачальника:
{data_json}
    """
    return prompt
